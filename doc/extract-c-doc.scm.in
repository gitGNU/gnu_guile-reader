#!/bin/sh

c_file="$1"
shift

exec @GUILE@ -L @top_srcdir@/module -l "$0"   \
     -e '(apply main (cdr (command-line)))'   \
     -- "$c_file" "@CPP@" "@CPPFLAGS@ -I@top_srcdir@" $@
!#

;;; extract-c-doc.scm  --  Output Texinfo from "snarffed" C files.
;;;
;;; Copyright 2006  Ludovic Courtès <ludovic.courtes@laas.fr>
;;;
;;;
;;; This program is free software; you can redistribute it and/or modify
;;; it under the terms of the GNU General Public License as published by
;;; the Free Software Foundation; either version 2 of the License, or
;;; (at your option) any later version.
;;;
;;; This program is distributed in the hope that it will be useful,
;;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;;; GNU General Public License for more details.
;;;
;;; You should have received a copy of the GNU General Public License
;;; along with this program; if not, write to the Free Software
;;; Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA

(use-modules (system documentation c-snarf)
             (system documentation output)

             (srfi srfi-1))


(define (main . args)
  ;; Arguments:
  ;;
  ;; 1. C file to be processed;
  ;; 2. how to invoke the CPP (e.g., "cpp -E");
  ;; 3. additional CPP flags (e.g., "-I /usr/local/include");
  ;; 4. optionally, a list of Scheme procedure names whose documentation is
  ;;    to be output.
  ;;
  (let* ((file (car args))
         (cpp+args (string-tokenize (cadr args)))
         (cpp (car cpp+args))
         (cpp-flags (apply string-append (caddr args)
                           " -DSCM_MAGIC_SNARF_DOCS "
                           (cdr cpp+args)))
         (procs (map string->symbol (cdddr args))))
    ;;(format (current-error-port) "cpp-flags: ~a~%" cpp-flags)
    (format (current-error-port) "extracting Texinfo doc from `~a'...  "
            file)
    (let ((proc-doc-list
           (run-cpp-and-extract-snarfing file cpp
                                         (string-tokenize cpp-flags))))
      (display (apply string-append
                      (map procedure-texi-documentation
                           (if (null? procs)
                               proc-doc-list
                               (filter (lambda (proc-doc)
                                         (memq (assq-ref proc-doc 'scheme-name)
                                               procs))
                                       proc-doc-list))))))
    (format (current-error-port) "done.~%")
    (exit 0)))


;;; Local Variables:
;;; mode: scheme
;;; coding: latin-1
;;; End:
